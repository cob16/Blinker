<!doctype html>
<html>
<head>
    <title>My fancy game</title>
</head>
<body>
<p>Use your arrow keys!</p>

<canvas id="canvas"></canvas>

<script>

    (function () {
        var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        window.requestAnimationFrame = requestAnimationFrame;
    })();

    var gameState = 'start';

    var health = 50;
    var maxHealth = 50;

    var health_bar = {
        x: 80,
        y: 14,
        width: 300,
        height: 20
    };

   var telaport = new Audio('assests/teleporter_send.wav');

   var canvas = document.getElementById("canvas"),
        ctx = canvas.getContext("2d"),
        width = 900,
        height = 700,
        player = {
            x: width / 2,
            y: height - 15,
            width: 10,
            height: 10,
            speed: 4,
            velX: 0,
            velY: 0,
            jumping: false,
            grounded: false
        },
        level = {
            current: 0,
            endLevel: 1,
            startX : 292,
            startY: 130,

            endX: 0,
            endY: 0
        }

        keys = [],
        friction = 0.8,
        gravity = 0.3;

        canvas.width = width;
        canvas.height = height;

        var boxes = [];

   var StartBtn = {
       w: 100,
       h: 50,
       x: canvas.width/2 - 50,
       y: canvas.height/2 - 25,
       draw: function() {
           ctx.fillStyle = "whitesmoke";
           ctx.fillRect(0, 0, canvas.width, canvas.height);
           ctx.fill();

           ctx.fillStyle = "black";
           ctx.strokeStyle = "#000000";
           ctx.lineWidth = "2";
           ctx.strokeRect(this.x, this.y, this.w, this.h);
           ctx.font = "18px Arial, sans-serif";
           ctx.textAlign = "center";
           ctx.textBaseline = "middle";
           ctx.fillStlye = "#000000";
           ctx.fillText("Start", canvas.width/2, canvas.height/2 );
       }
   };

    function restartLevel() {
        //console.log("Level Restarted");
        health = maxHealth;
        player.x = level.startX;
        player.y = level.startY;
        player.velX = 0;
        player.velY = 0;
        player.jumping = false;
        player.grounded = false;
        console.log("Player sent to ("+player.x+","+player.y+")");
    }

    function loadnewlevel(filename) {

        console.log("loading:" + filename);

        //remove old level
        delete boxes;

        //load the new level
        var js = document.createElement('script');
        js.type = "text/javascript";
        js.src = filename;
        document.body.appendChild(js);

        console.log("Loading Compete");
    }

    function nextLevel() {
        if (level.current < level.endLevel) {
            updateLocalStorage();
            loadnewlevel("level." + ++level.current + ".js");
            //todo save points to loal storage
            restartLevel();
        }
    }

    function createLocalStorage() {
        for (var i = 0; i <= level.endLevel; i++) { //make highscore table
            localStorage.setItem("levelScore-" + i, 0);
        }
    }

    function updateLocalStorage(i) {

        if(localStorage.getItem("health") == null) {createLocalStorage();}

//        if(typeof i == "undefined"){
//            console.error("missing parameter when calling updateLocalStorage")
//            return;
//        }

        var key = "levelScore-" + level.current;
        if (localStorage.getItem(key) < health) {
            localStorage.setItem(key, health);
        }
    }

    function click(event)
    {

        if (gameState == "start") {
            gameState = "playing";
            //todo create high score if none exisits
            restartLevel();
            return;
        }
        if (gameState == "game over") {
            gameState = "playing";
            restartLevel();
            return;
        }

        var bounding_box = canvas.getBoundingClientRect();
        var x = (event.clientX - bounding_box.left) *
                (canvas.width / bounding_box.width);
        var y = (event.clientY - bounding_box.top) *
                (canvas.height / bounding_box.height);

            //get a number that inceces the further the mose positon is away from the plaer
        var dif = Math.round(Math.abs((player.x - x) / 100)) +
                Math.round(Math.abs((player.y - y) / 100));

        if (dif < 1) {
            dif = 1
        }
            //alert(dif);
        health -= dif;

        if (health < 0) {
            health = 0;
        }
        //move the player to positon
        player.x = x;
        player.y = y;

        console.log("telaport(" + x + "," + y + ")" );

        player.jumping = true;
        player.grounded = false;
        player.velX = 0;
        player.velY = 0;

        telaport.play();
    }

    function movement() {
        if (keys[38] || keys[87] || keys[32]) { // up arrow or w or space
            if (!player.jumping && player.grounded) {
                player.jumping = true;
                player.grounded = false;
                player.velY = -player.speed * 2;
            }
        }
        if (keys[39] || keys[68]) { // right arrow
            if (player.velX < player.speed) {
                player.velX++;
            }
        }
        if (keys[37] || keys[65]) { // left arrow
            if (player.velX > -player.speed) {
                player.velX--;
            }
        }
        if (keys[82]) { // r
            restartLevel();
        }

        if (keys[75]) { // r
            //todo debug key
        }


        player.velX *= friction;
        player.velY += gravity;
    }

    function update() {

        ctx.clearRect(0, 0, width, height); //clear all

        if (gameState == "start")
        {
            console.log("loading start screen");
            StartBtn.draw();
        }
        else {

            ctx.fillStyle = "whitesmoke";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fill();


            if (health <= 0) {
                updateGameOver();
            } else {
                // check keys
                movement();

                ctx.fillStyle = "black";
                ctx.beginPath();

                player.grounded = false;
                for (var i = 0; i < boxes.length; i++) {
                    ctx.rect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);

                    var dir = colCheck(player, boxes[i]);

                    if (dir === "l" || dir === "r") {
                        player.velX = 0;
                        player.jumping = false;
                    } else if (dir === "b") {
                        player.grounded = true;
                        player.jumping = false;
                    } else if (dir === "t") {
                        player.velY *= -1;
                    }

                }

                if (player.grounded) {
                    player.velY = 0;
                }

                player.x += player.velX;
                player.y += player.velY;

                ctx.fill();
                ctx.fillStyle = "red";
                ctx.fillRect(player.x, player.y, player.width, player.height);

                //HP BAR
                var percent = health / maxHealth;

                ctx.fillStyle = "grey";
                ctx.fillRect(health_bar.x, health_bar.y, health_bar.width, health_bar.height);
                ctx.fillStyle = "red";
                ctx.fillRect(health_bar.x, health_bar.y, health_bar.width * percent, health_bar.height);

                ctx.fillStyle = "Red";
                ctx.fillText("Health: ", 40, 25);
                ctx.fillText(health + "/" + maxHealth, 415, 25);

                ctx.fillStyle = "white";
                ctx.fillText("Level: " + level.current, canvas.width-50, 25);
            }
        }

        requestAnimationFrame(update);
    }

    function colCheck(shapeA, shapeB) {
        // get the vectors to check against
        var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
            vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
            // add the half widths and half heights of the objects
            hWidths = (shapeA.width / 2) + (shapeB.width / 2),
            hHeights = (shapeA.height / 2) + (shapeB.height / 2),
            colDir = null;

        // if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
        if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
            // figures out on which side we are colliding (top, bottom, left, or right)
            var oX = hWidths - Math.abs(vX),
                oY = hHeights - Math.abs(vY);
            if (oX >= oY) {
                if (vY > 0) {
                    colDir = "t";
                    shapeA.y += oY;
                } else {
                    colDir = "b";
                    shapeA.y -= oY;
                }
            } else {
                if (vX > 0) {
                    colDir = "l";
                    shapeA.x += oX;
                } else {
                    colDir = "r";
                    shapeA.x -= oX;
                }
            }
        }
        return colDir;
    }

    function updateGameOver() {

        gameState = "game over";

        var restartBtn = {
            w: 100,
            h: 50,
            x: canvas.width/2 - 50,
            y: canvas.height/2 - 50,

            draw: function() {
                ctx.fillStyle = "black";
                ctx.strokeStyle = "#000000";
                ctx.lineWidth = "2";
                ctx.strokeRect(this.x, this.y, this.w, this.h);

                ctx.font = "18px Arial, sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillStlye = "#000000";

                ctx.fillText("Restart", canvas.width/2, canvas.height/2 - 25);
            }
        };

        restartBtn.draw();

        ctx.fillStlye = "Black";
//        //ctx.fillText("Game Over - You scored "+points+" points!", canvas.width/2, canvas.height/2 + 25 );
        ctx.fillText("Game Over!", canvas.width/2, canvas.height/2 + 25 );
        ctx.fillText("You scored PLACEHOLDER points!", canvas.width/2, canvas.height/2 + 75 );

//        requestAnimationFrame(updateGameOver);
    }

    function state() {

        update();
//
//    while (true) {
//
//        if (update() == "game over") {
//            console.log("game over");
//            gameState = state;
//            updateGameOver();
//        }
//
//        console.log("IT FUCKING BROKEN!");
//
////       if (update().isEqual("game over")) {
////
////       } else if(update().isEqual("next level"){
////
////       }
//    }
    }

    document.body.addEventListener("keydown", function (e) {
        keys[e.keyCode] = true;
    });

    document.body.addEventListener("keyup", function (e) {
        keys[e.keyCode] = false;
    });


    window.addEventListener("load", function () {
        loadnewlevel("level.0.js");
        state();
    });

    canvas.addEventListener("mousedown", click, false);

</script>
</body>
</html>